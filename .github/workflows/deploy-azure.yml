name: CD - Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build
        env:
          # Dummy values for build - actual values are in Azure App Settings
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          INVITE_TOKEN_SECRET: dummy-secret-for-build-only
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure
        if: github.event_name == 'workflow_dispatch'
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ vars.AZURE_RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: >
            location=${{ vars.AZURE_LOCATION }}
            appName=${{ vars.AZURE_APP_NAME }}
            postgresServerName=${{ vars.POSTGRES_SERVER_NAME }}
            dbAdminUser=${{ vars.DB_ADMIN_USER }}
            dbAdminPassword=${{ secrets.DB_ADMIN_PASSWORD }}
            inviteTokenSecret=${{ secrets.INVITE_TOKEN_SECRET }}
            authClientId=${{ secrets.AUTH_CLIENT_ID }}
            authClientSecret=${{ secrets.AUTH_CLIENT_SECRET }}
            authIssuerUri=${{ vars.AUTH_ISSUER_URI }}
          deploymentName: 'pipr-${{ github.run_number }}'

      - name: Create deployment package
        run: |
          # Create a zip file with necessary files for deployment
          # Exclude node_modules, .next, and dev-only config files
          # Azure will build the app during deployment
          zip -r deploy.zip \
            package.json \
            package-lock.json \
            next.config.js \
            tsconfig.json \
            postcss.config.js \
            tailwind.config.js \
            app \
            src \
            prisma \
            public

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_APP_NAME }}
          package: deploy.zip

      - name: Run Database Migrations
        run: |
          set -e  # Fail fast on any error
          # Get database URL from Azure Key Vault
          DATABASE_URL=$(az keyvault secret show \
            --vault-name ${{ vars.AZURE_APP_NAME }}-kv \
            --name database-url \
            --query value -o tsv)

          if [ -z "$DATABASE_URL" ]; then
            echo "Error: Failed to retrieve DATABASE_URL from Key Vault"
            exit 1
          fi

          # Run Prisma migrations
          DATABASE_URL=$DATABASE_URL npx prisma migrate deploy

      - name: Cleanup
        if: always()
        run: rm -f deploy.zip

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: ${{ vars.AZURE_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: ${{ vars.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ vars.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL**: https://${{ vars.AZURE_APP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
